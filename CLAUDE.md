# CLAUDE.md

This file provides guidance to Claude Code when working with this repository.

## Project Overview

MCP Gateway is an Envoy-based gateway for Model Context Protocol (MCP) servers. Single binary (`mcp-broker-router`) with three components:
- **MCP Router**: Envoy external processor that routes MCP requests (gRPC on :50051)
- **MCP Broker**: HTTP service that aggregates tools from multiple MCP servers (HTTP on :8080/mcp)
- **MCP Controller**: Kubernetes controller that discovers MCP servers via MCPServer CRDs (optional, `--controller` flag)

## Architecture

```
Client ‚Üí Gateway (Envoy) ‚Üí Router (ext_proc) ‚Üí Broker ‚Üí Upstream MCP Servers
                ‚Üë                                 ‚Üë
           Controller ‚Üí ConfigMap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

- Controller watches MCPServer CRDs, discovers backends via HTTPRoutes, writes ConfigMap
- Broker reads ConfigMap, connects to upstream servers, federates tools with prefixes
- Router parses MCP requests, adds auth headers, tells Envoy where to route
- All MCP traffic flows through Envoy for consistent policies

**Important**: We use Istio ONLY as a Gateway API provider, NOT as a service mesh:
- No sidecars on any workload pods
- No ambient mode (no ztunnels or waypoint proxies)
- Just `istiod` programming the Gateway's Envoy proxy
- ServiceEntry/DestinationRule only used for external service routing

## Key Files

### Core Components
- `cmd/mcp-broker-router/main.go`: Binary entry point
- `internal/broker/broker.go`: MCP broker implementation
- `internal/mcp-router/server.go`: Envoy external processor
- `pkg/controller/mcpserver_controller.go`: MCPServer reconciliation

### Configuration
- `config/crd/mcp.kagenti.com_*.yaml`: CRD definitions (generated by controller-gen)
- `config/mcp-system/`: Kubernetes deployment manifests
- `config/test-servers/`: Test MCP server deployments
- `docs/guides/external-mcp-server.md`: Guide for connecting to external MCP servers
- `docs/examples/github-mcp-external.yaml`: Example manifest for GitHub MCP integration

## Development

### Quick Start
```bash
make local-env-setup     # Create Kind cluster with everything
make reload              # Build, load to Kind, and restart controller and broker
```

### Testing
```bash
make lint               # Run all lint and style checks
make test-unit          # Unit tests
make test-e2e-ci        # E2E tests for CI environment
make test-e2e           # E2E tests with local Kind cluster

# Running specific E2E tests locally
cd tests/e2e && go test -v -tags=e2e -run TestE2E -ginkgo.focus="test description" -timeout 5m

# Alternative with ginkgo CLI
ginkgo run -v --tags=e2e --focus="test description" tests/e2e/
```

### E2E Test Reliability
- Tests use broker `/status` endpoint for reliable server registration checks (not log parsing)
- Port-forwards target deployments directly: `deployment/mcp-broker-router`
- Tests clean up existing resources before creating to avoid conflicts
- Structured JSON responses provide better debugging when tests fail

### Conformance Tests
MCP conformance tests verify that the gateway correctly implements the Model Context Protocol specification. These tests are sourced from the official `@modelcontextprotocol/conformance` npm package maintained by Anthropic.

**Test scenarios currently run in CI** (`.github/workflows/conformance.yaml`):
- `server-initialize`: Server initialization handshake
- `tools-list`: Tool listing and discovery
- `tools-call-simple-text`: Simple text tool responses
- `tools-call-image`: Image content in tool responses
- `tools-call-audio`: Audio content in tool responses
- `tools-call-embedded-resource`: Embedded resource handling
- `tools-call-mixed-content`: Mixed content type responses
- `tools-call-error`: Error handling and propagation
- `tools-call-with-progress`: Progress notification support

**Running conformance tests locally**:
```bash
make deploy-conformance-server  # Deploy test server to Kind cluster

# Run specific scenario
npx @modelcontextprotocol/conformance server \
  --url http://mcp.127-0-0-1.sslip.io:8001/mcp \
  --scenario server-initialize

# Run all active scenarios
npx @modelcontextprotocol/conformance server \
  --url http://mcp.127-0-0-1.sslip.io:8001/mcp
```

**Updating CI test scenarios**:
1. Check available scenarios: `npx @modelcontextprotocol/conformance list`
2. Add new scenario blocks to `.github/workflows/conformance.yaml` under the "Run MCP conformance tests" step
3. Each scenario runs as a separate `npx @modelcontextprotocol/conformance server --url ... --scenario <name>` command

### CI/CD Optimizations
All GitHub workflows have concurrency control to cancel stale runs:
```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
```
This prevents resource waste during rapid development/force-pushing.

### Important Ports
- 8080: Broker HTTP (/mcp endpoint)
- 50051: Router gRPC (ext_proc)
- 8081: Controller health probes
- 8001: Gateway port mapping
- 8002: Keycloak port mapping

## Known Issues & Solutions

### Flaky E2E Tests
**Problem**: Tests timeout waiting for broker to register servers due to:
- ConfigMap volume mount sync delays (60-120s in Kubernetes)
- Log-based checks becoming unreliable

**Solution**: Use broker `/status` API endpoint instead of log parsing for all server state checks.

## Current Status

### Working ‚úÖ
- MCP broker federates tools from multiple servers with prefixes
- Controller discovers servers via HTTPRoutes and generates ConfigMap
- Authentication via Kubernetes secrets and env vars
- Dynamic config updates via HTTP push API
- Tool call forwarding to upstream servers
- E2E tests validate full flow
- toolPrefix field immutability enforced via CEL validation
- External MCP servers via Hostname backendRef + ServiceEntry/DestinationRule
- Tool discovery from external MCP servers (GitHub MCP: 94 tools discovered)
- Controller correctly generates HTTPS URLs for external services
- Router (ext_proc) properly sets routing headers:
  - `:authority` header set to HTTPRoute hostname (URLRewrite filter handles external rewrite)
  - `:path` header set to custom path (e.g., `/v1/special/mcp`) when specified
  - `x-mcp-api-key` header for backend API keys (to avoid OAuth conflicts)
  - Authorization header added with Bearer token
  - Tool name prefix stripping working correctly
- Custom MCP paths:
  - MCPServer CRD supports `path` field for non-standard endpoints
  - Controller includes custom paths in ConfigMap
  - Broker connects to custom path endpoints successfully
  - Router sets `:path` header for custom paths

### Not Implemented üìù
- Notification brokering (`tools/list_changed` events)
- EnvoyFilter creation by controller
- Resource/prompt federation (only tools currently)

## MCPServer Resource

```yaml
apiVersion: mcp.kagenti.com/v1alpha1
kind: MCPServer
metadata:
  name: weather-service
  namespace: mcp-test
spec:
  toolPrefix: weather_      # Prefix for federated tools (immutable once set)
  path: /v1/custom/mcp      # Optional custom path (default: /mcp)
  targetRef:                # HTTPRoute reference
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: weather-route
  credentialRef:            # Optional auth
    name: weather-secret
    key: token
```

### Custom Paths

MCPServer CRD has optional `path` field (defaults to `/mcp`):
- Controller includes full URL with custom path in ConfigMap
- Broker successfully connects to custom endpoints and discovers tools
- Router sets `:path` header when path != `/mcp`

**HTTPRoute Requirements**:
- HTTPRoute must have a hostname that matches a Gateway listener
- For internal services, use `*.mcp.local` pattern (matches wildcard listener)
- HTTPRoute should include path match for the custom path

Example:
```yaml
apiVersion: mcp.kagenti.com/v1alpha1
kind: MCPServer
metadata:
  name: custom-path-server
  namespace: mcp-test
spec:
  path: /v1/special/mcp    # Custom endpoint
  toolPrefix: custom_
  targetRef:
    kind: HTTPRoute
    name: custom-path-route
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: custom-path-route
  namespace: mcp-test
spec:
  hostnames:
  - custom.mcp.local       # Must match Gateway listener
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /v1/special/mcp
    backendRefs:
    - name: custom-mcp-service
      port: 8080
```
- Useful for servers that expose MCP on non-standard endpoints

### External Services
The controller automatically detects external services. When the HTTPRoute backend name looks like an external hostname (e.g., `api.githubcopilot.com`), the controller uses it directly instead of constructing internal Kubernetes DNS names. Detection criteria:
- Contains dots (.)
- Doesn't end with `.local`, `.svc`, or `.cluster.local`
- Has at least 2 parts when split by dots

For external services, create appropriate Istio ServiceEntry and HTTPRoute resources. See `docs/guides/external-mcp-server.md` for detailed instructions.

## Authentication

MCP servers can require authentication:
1. MCPServer spec includes `credentialRef` pointing to a Kubernetes secret
   - **Important**: Secret must have label `mcp.kagenti.com/credential=true`
   - Without this label, the MCPServer will fail validation
2. Controller aggregates credentials into `mcp-aggregated-credentials` secret
3. Broker receives via environment variables: `KAGENTI_{NAME}_CRED`
4. Router adds Authorization header to Envoy routing instructions

Example credential secret:
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: weather-secret
  namespace: mcp-test
  labels:
    mcp.kagenti.com/credential: "true"  # required label
type: Opaque
stringData:
  token: "Bearer your-api-token"
```

### Credential Value Change Detection
The system handles credential updates automatically:
1. Controller uses APIReader to bypass cache when reading credential secrets
2. Broker detects credential value changes and re-registers servers automatically
3. Exponential backoff retry for servers with credentials (5s ‚Üí 10s ‚Üí 20s ‚Üí 40s ‚Üí 60s)

**Timing**:
- Controller ‚Üí Aggregated Secret: Fast (~5 seconds)
- Aggregated Secret ‚Üí Volume Mount: 60-120 seconds (Kubernetes kubelet sync limitation)
- Total sync time: ~60-120 seconds

This is a Kubernetes limitation - volume mounts sync every 60s by default and cannot be configured lower.

### OAuth + API Key Conflict (Issue #201)
**Problem**: When using AuthPolicy (e.g., Kuadrant/Authorino), there's a timing issue where ext_proc runs FIRST and AuthPolicy runs SECOND. If ext_proc replaces the OAuth token with an API key, AuthPolicy fails.

**Solution**: The router now sets both headers:
- `x-mcp-api-key`: Backend API key (always set when credentials exist)
- `authorization`: Only set if no existing Authorization header present (for backwards compatibility)

This allows AuthPolicy to validate the OAuth token while backends receive their required API keys via the `x-mcp-api-key` header.

## Test Servers

Test servers in `config/test-servers/`:
- **Server1**: Go SDK (tools: hi, time, slow, headers)
- **Server2**: Go SDK (tools: hello_world, time, headers, auth1234, slow)
- **Server3**: Python FastMCP (tools: time, add, dozen, pi, get_weather, slow)
- **API Key Server**: Validates Bearer token authentication (tool: hello_world)
- **Broken Server**: Intentionally broken server for testing error handling
- **Custom Path Server**: Go SDK at `/v1/special/mcp` (tools: echo_custom, path_info, timestamp)
- **OIDC Server**: Validates OpenID Connect (OIDC) Bearer tokens
- **Everything Server**: Typescript SDK (prompts, tools, resources, sampling)
- **Conformance Server**: Typescript SDK conformance test server
- **Custom Response Server**: Tests custom response handling

## Code Style

- Minimal, terse comments (lowercase, only when necessary)
- No emojis or AI-style formatting
- Files must end with newline
- Regularly run make lint to check for lint errors.

## MCP Inspector

The MCP Inspector web UI supports URL parameters for configuration:

- `transport` (required): Transport method for MCP connection
  - `stdio`: For stdio-based servers (requires `serverPath`)
  - `sse`: For SSE/HTTP servers (requires `serverUrl`)
  - `streamable-http`: For streamable HTTP servers (requires `serverUrl`)
- `serverUrl`: URL of the MCP server (for SSE/streamable-http transports)
- `serverPath`: Path to stdio.js file (for stdio transport)
- `MCP_PROXY_AUTH_TOKEN`: Authentication token (auto-generated by mcp-inspector)

Environment variables:
- `MCP_AUTO_OPEN_ENABLED=false`: Prevents automatic browser opening (default: true)
- `CLIENT_PORT`: Custom port for the inspector UI (default: 6274)
- `SERVER_PORT`: Custom port for the proxy server (default: 6277)

The make targets now handle URL parameters automatically:
- `make inspect-gateway` - Opens inspector for the gateway
- `make inspect-server1` - Opens inspector for test server 1
- `make inspect-server2` - Opens inspector for test server 2
- `make inspect-server3` - Opens inspector for test server 3
- `make inspect-api-key-server` - Opens inspector for API key test server (requires auth)
- `make inspect-custom-path-server` - Opens inspector for custom path test server


## External MCP Server Support (Issue #166)

External MCP server support (e.g., GitHub Copilot MCP). Clients call your Gateway's hostname, Gateway rewrites and routes to external service.

### Architecture Flow
```
Client ‚Üí Gateway (*.mcp.local listener) ‚Üí URLRewrite ‚Üí External MCP Server
                    ‚Üë
             Router (adds auth header)
```

### How It Works

1. **ServiceEntry + DestinationRule** - registers external host in Istio's service registry with TLS settings
2. **HTTPRoute with Hostname backendRef** - uses `kind: Hostname, group: networking.istio.io` to reference external host directly (no ExternalName Service needed)
3. **URLRewrite filter** - rewrites `:authority` header to external hostname
4. **Credentials** - Controller aggregates credentials, Router adds auth headers

### Working Example Configuration

```yaml
# HTTPRoute with Hostname backendRef (no ExternalName Service needed)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: github-mcp-external
  namespace: mcp-test
spec:
  parentRefs:
  - name: mcp-gateway
    namespace: gateway-system
  hostnames:
  - github.mcp.local  # matches *.mcp.local listener
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /mcp
    filters:
    - type: URLRewrite
      urlRewrite:
        hostname: api.githubcopilot.com
    backendRefs:
    - name: api.githubcopilot.com
      kind: Hostname
      group: networking.istio.io
      port: 443
```

### Common Issues and Solutions

- **401 Unauthorized**: Wrong token format (use PAT with `ghp_` prefix, include "Bearer " prefix)
- **No tools discovered**: Token invalid or missing "Bearer " prefix
- **Connection refused**: Missing ServiceEntry or DestinationRule for external host

See `docs/guides/external-mcp-server.md` for complete setup instructions.
